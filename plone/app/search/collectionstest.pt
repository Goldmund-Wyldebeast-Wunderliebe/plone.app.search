<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      lang="en"
      metal:use-macro="context/main_template/macros/master"
      i18n:domain="plone">
<head>
    <metal:block metal:fill-slot="head_slot">
    <!-- XXX FIX XXX -->
    
        <link rel="alternate" title="RSS 1.0" type="application/rss+xml"
              tal:define="here_url context/@@plone_context_state/object_url"
              tal:condition="request/SearchableText|nothing"
              tal:attributes="href string:$here_url/search_rss?${request/QUERY_STRING}"/>

<style type="text/css">
.queryindex, .addIndex {
    display: block;
    width: 200px;
    float: left;
    margin-right: 0.5em;
}
.queryoperator, .addOperator {
    display: block;
    width: 150px;
    float: left;
    margin-right: 0.5em;
}
.queryresults {
    float: right;
}
.previewSearchResultsHeading {
    margin-top: 1em;
}
#advancedsearch .field {
    margin: 0 1em 0.5em 0;
}
.removecriteria {
    border: 0;
    padding: 0;
    background: transparent;
    cursor: pointer;
}
.multipleSelectionWidget {
    overflow:auto; 
    height:6em;
}
.queryvalue {
    float: left;
    width: 200px;
    border-width: 1px;
}
dl.queryvalue {
    margin: 0;
}
dl.queryvalue dd {
    margin: 0;
}
.dateRangeWidget input {
    width: 80px;
}
div.queryvalue, dl.queryvalue {
    border: solid 1px transparent;
}
</style>

<script tal:content="python:view.getJavascriptConfig()"></script>
<script type="text/javascript">
jQuery(function($) {

    // Create a select menu
    function CreateSelect(values, selectedvalue, class, name) {
        // Create select
        var select = $(document.createElement('select'))
                            .addClass(class)
                            .attr('name', name)
        $.each(values, function (i, val) {
            var option = $(document.createElement('option'))
                            .attr('value', i)
                            .html(val.friendly_name)
            if (i == selectedvalue) {
                option.attr('selected', 'selected');
            }
            select.append(option);
        });
        return select;
    }

    // Create a queryindex select menu
    function CreateQueryIndex(value) {
        return CreateSelect(plone_app_search_config.indexes,
                            value,
                            'queryindex',
                            'query.i:records');
    }

    // Create a queryoperator select menu
    function CreateQueryOperator(index, value) {
        return CreateSelect(plone_app_search_config.indexes[index].operators,
                            value,
                            'queryoperator',
                            'query.o:records');
    }

    // Enhance for javascript browsers
    $(document).ready(function () {
        $('div.queryindex').each(function () {
            $(this).before(
                $(document.createElement('div'))
                    .addClass('queryresults discreet')
                    .html('')
            )
            $(this).replaceWith(CreateQueryIndex($(this).children('input').val()));
        });
        $('div.queryoperator').each(function () {
            $(this).replaceWith(CreateQueryOperator($(this).parents('.field').children('.queryindex').val(),
                                                    $(this).children('input').val()));
        });
        $(".formControls").hide();
        $(".addIndexButton").hide();
        UpdateSearch();
    });

    $('.queryindex').live('change', function () {
        $(this).parent().children('.queryoperator')
            .replaceWith(CreateQueryOperator($(this).children(':selected')[0].value, ''));
        UpdateSearch();
    });

    $('#sort_on,#sort_order,.queryoperator').live('change', function () {
        UpdateSearch();
    });

    $('.queryvalue').live('keyup', function () {
        UpdateSearch();
    });
    $('.queryvalue').live('keydown', function (e) {
        if (e.keyCode == 13) {
            return false;
        }
    });

    $('.addIndex').live('change', function () {
        var value = $(this).children(':selected')[0].value;
        var field = $(this).parents('.field');
        var newfield = $(document.createElement('div'))
                            .addClass('field');

        newfield.append(
                $(document.createElement('div'))
                    .addClass('queryresults discreet')
                    .html('')
            )
        newfield.append(CreateQueryIndex(value));
        newfield.append(CreateQueryOperator(value,''));
        newfield.append(
            $(document.createElement('input'))
                .attr({
                    'type': 'text',
                    'value': '',
                    'name': 'query.v:records',
                    'autocomplete': 'off'
                })
                .addClass('queryvalue')
        )
        newfield.append(
            $(document.createElement('a'))
                .attr({
                    'title': 'Remove criteria',
                    'href': ''
                })
                .addClass('removecriteria discreet')
                .html('Remove criteria')
        )
        field.before(newfield);
        $(this).val('');
    });

    $('.removecriteria').live('click', function () {
        $(this).parents('.field').remove();
        UpdateSearch();
        return false;
    });

    function UpdateSearch() {
        var query = "previewadvancedsearchresults?";
        var querylist  = [];
        $('#advancedsearch .queryindex').each(function () {
            var results = $(this).parents('.field').children('.queryresults');
            querylist.push('query.i:records=' + $(this).val());
            querylist.push('query.o:records=' + $(this).parents('.field').children('.queryoperator').val());
            querylist.push('query.v:records=' + $(this).parents('.field').children('.queryvalue').val());

            $.get('previewadvancedsearchnumberofresults?' + querylist.join('&'),
                  {},
                  function (data) { results.html(data); });
        });
        query += querylist.join('&');
        query += '&sort_on=' + $('#sort_on').val();
        if ($('#sort_order:checked').length > 0) {
            query += '&sort_order=reverse'
        }
        $.get(query, {}, function (data) { $('#searchresults').html(data); });
    }
}(jQuery))
</script>
    </metal:block>

    <metal:block fill-slot="top_slot"
                 tal:define="dummy python:request.set('disable_border',1)" />
    <metal:block fill-slot="column_one_slot" />
    <metal:block fill-slot="column_two_slot" />
</head>

<body>
<div metal:fill-slot="main" tal:define="config python:view.getConfig();
                                        indexes config/indexes;
                                        sortable_indexes config/sortable_indexes;
                                        addindexselected python:request.has_key('addindex') and request.addindex != '';
                                        addoperatorselected python:request.has_key('addoperator') and request.addoperator != ''">
    <form action="" method="get" accept-charset="utf-8" id="advancedsearch">
        <fieldset>
            <legend>Criteria</legend>
            <div class="field"
                 tal:repeat="row context/REQUEST/form/query"
                 tal:condition="exists: context/REQUEST/form/query">

                <div class="queryindex">
                    <input type="hidden" name="query.i:records"
                           tal:attributes="value row/i" />
                    <span tal:content="python:indexes[row.i]['friendly_name']"/>
                </div>

                <div class="queryoperator">
                    <input type="hidden" name="query.o:records"
                           tal:attributes="value row/o" />
                    <span tal:content="python:indexes[row.i]['operators'][row.o]['friendly_name']"/>
                </div>

                <input class="queryvalue stringWidget"
                       autocomplete="off" type="text" name="query.v:records"
                       tal:attributes="value python:row['v']"
                       tal:condition="python:indexes[row.i]['operators'][row.o]['widget'] == 'StringWidget'"/>

                <dl class="queryvalue multipleSelectionWidget"
                     tal:condition="python:indexes[row.i]['operators'][row.o]['widget'] == 'MultipleSelectionWidget'">
                    <dt class="hiddenStructure">Select...</dt>
                    <dd><input type="checkbox" name="query.v:records" value="Repeat Value" />Repeat Value</dd>
                </dl>

                <dl class="queryvalue locationWidget"
                     tal:condition="python:indexes[row.i]['operators'][row.o]['widget'] == 'LocationWidget'">
                    <dt class="hiddenStructure">Select...</dt>
                    <dd><input autocomplete="off" type="text" name="query.v:records"
                               tal:attributes="value python:row['v']" /></dd>
                </dl>

                <dl class="queryvalue dateWidget"
                    tal:condition="python:indexes[row.i]['operators'][row.o]['widget'] == 'DateWidget'">
                    <input autocomplete="off" type="text" class="queryvalue" name="query.v:records"
                           tal:attributes="value python:row['v']"/>
                </dl>

                <div class="queryvalue dateRangeWidget"
                     tal:condition="python:indexes[row.i]['operators'][row.o]['widget'] == 'DateRangeWidget'">
                    <input autocomplete="off" type="text" name="query.v:records"
                           tal:attributes="value python:row['v']"/>
                    <span>and</span>
                    <input autocomplete="off" type="text" name="query.v:records"
                           tal:attributes="value python:row['v']"/>
                </div>

                <input type="submit" name="removecriteria" class="removecriteria discreet" value="Remove criteria">
            </div>

            <div class="field" tal:condition="python: addindexselected and addoperatorselected">

                <div class="queryindex">
                    <input type="hidden" name="query.i:records"
                           tal:attributes="value context/REQUEST/form/addindex" />
                    <span tal:content="python:indexes[request.form['addindex']]['friendly_name']"/>
                </div>

                <div class="queryoperator">
                    <input type="hidden" name="query.o:records"
                           tal:attributes="value context/REQUEST/form/addoperator" />
                    <span tal:content="python:indexes[request.form['addindex']]['operators'][request.form['addoperator']]['friendly_name']"/>
                </div>

                <input class="queryvalue stringWidget"
                       autocomplete="off" type="text" name="query.v:records" value=""
                       tal:condition="python:indexes[request.form['addindex']]['operators'][request.form['addoperator']]['widget'] == 'StringWidget'"/>

                <div class="queryvalue multipleSelectionWidget"
                     tal:condition="python:indexes[request.form['addindex']]['operators'][request.form['addoperator']]['widget'] == 'MultipleSelectionWidget'">
                    <dl>
                        <dt class="hiddenStructure">Select...</dt>
                        <dd><input type="checkbox" name="query.v:records" value="Repeat Value" />Repeat Value</dd>
                    </dl>
                </div>

                <div class="queryvalue locationWidget"
                     tal:condition="python:indexes[request.form['addindex']]['operators'][request.form['addoperator']]['widget'] == 'LocationWidget'">
                    <dl>
                        <dt class="hiddenStructure">Select...</dt>
                        <dd><input autocomplete="off" type="text" name="query.v:records"/></dd>
                    </dl>
                </div>

                <div class="queryvalue dateWidget"
                     tal:condition="python:indexes[request.form['addindex']]['operators'][request.form['addoperator']]['widget'] == 'DateWidget'">
                     <input autocomplete="off" type="text" class="queryvalue" name="query.v:records"/>
                </div>

                <div class="queryvalue dateRangeWidget"
                     tal:condition="python:indexes[request.form['addindex']]['operators'][request.form['addoperator']]['widget'] == 'DateRangeWidget'">
                    <input autocomplete="off" type="text" name="query.v:records"/>
                    <span>and</span>
                    <input autocomplete="off" type="text" name="query.v:records"/>
                </div>

                <input type="submit" name="removecriteria" class="removecriteria discreet" value="Remove criteria">
            </div>

            <div class="field">
                <label for="addindex" class="hiddenStructure">Add criteria</label>

                <select class="addIndex" name="addindex" tal:condition="python: not(addindexselected) or addoperatorselected">
                    <option value="" selected="selected">Add criteria...</option>
                    <tal:index repeat="index python:indexes.keys()">
                    <option tal:attributes="value index;"
                            tal:content="python:indexes[index]['friendly_name']">Index</option>
                    </tal:index>
                </select>

                <div class="addIndex" tal:condition="python: addindexselected and not(addoperatorselected)">
                    <input type="hidden" name="addindex"
                           tal:attributes="value context/REQUEST/form/addindex"/>
                    <span tal:content="python:indexes[request.form['addindex']]['friendly_name']"/>
                </div>

                <select class="addOperator" name="addoperator" tal:condition="python: addindexselected and not(addoperatorselected)">
                    <option value="" selected="selected">Add criteria...</option>
                    <tal:index repeat="index python:indexes[request.form['addindex']]['operators'].keys()">
                    <option tal:attributes="value index;"
                            tal:content="python:indexes[request.form['addindex']]['operators'][index]['friendly_name']">Index</option>
                    </tal:index>
                </select>

                <input type="submit" value="Add criteria" name="form.button.addcriteria" class="context addIndexButton"/>
            </div>
        </fieldset>

        <fieldset>
            <legend>Display options</legend>

            <div class="sortingField">
                <div class="formHelp"><!-- --></div>
                <label for="sort_on">
                    Sort on
                </label>
                <select name="sort_on" id="sort_on">
                    <tal:index repeat="index python:sortable_indexes.keys()">
                        <option tal:attributes="value index; selected python:(request.has_key('sort_on') and request.sort_on == index) and 'selected' or nothing" 
                                tal:content="python:sortable_indexes[index]['friendly_name']">Index</option>
                    </tal:index>
                </select>

                <input type="checkbox" name="sort_order" value="reverse" checked="checked" id="sort_order"/>
                <label for="sort_order">Reversed order</label>
            </div>

        </fieldset>

        <div class="formControls">
            <input type="submit" value="Save" name="form.button.save" class="context"/>
        </div>
    </form>
    <div id="searchresults" tal:content="structure view/previewSearchResults">
    </div>
</div>

</body>
</html>




